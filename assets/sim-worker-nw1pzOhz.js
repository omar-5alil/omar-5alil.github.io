(function(){"use strict";self.addEventListener("message",t=>{const n=t.data;if(!n||n.cmd!=="run")return;const i=n.params,s=at(i);self.postMessage({type:"simResult",xs:s.xs,lats:s.lats,lons:s.lons,alts:s.alts,vs:s.vs,wzs:s.wzs,times:s.times,ms:s.ms,crater_km:s.crater_km,mw:s.mw,tsunami_m:s.tsunami_m,meta:s.meta},[s.xs,s.lats,s.lons,s.alts,s.vs,s.wzs,s.times,s.ms])});function S(t){return t*Math.PI/180}function X(t){return t*180/Math.PI}function U(t,n,i,s){const e=S(t),x=S(n),c=S(i),r=s/6371e3,m=Math.sin(e)*Math.cos(r)+Math.cos(e)*Math.sin(r)*Math.cos(c),M=Math.asin(Math.max(-1,Math.min(1,m))),l=Math.sin(c)*Math.sin(r)*Math.cos(e),h=Math.cos(r)-Math.sin(e)*Math.sin(M),A=x+Math.atan2(l,h);return[X(M),(X(A)+540)%360-180]}function W(t){return t>86e3?1.225*Math.exp(-t/4e4)*1e-6:t>5e4?1.225*Math.exp(-5.882352941176471)*Math.exp(-(t-5e4)/7e3):1.225*Math.exp(-t/8500)}function B(t,n){const i=t.vx,s=t.wz,a=t.m,e=Math.sqrt(i*i+s*s)||1e-6,x=Math.PI*(n.radius*n.radius),c=W(Math.max(0,t.z));let r=n.Cd;e>15e3?r=.3:e>8e3?r=.5:r=1;const m=.5*r*c*x*e*e/Math.max(1e-9,a),M=-m*(i/e),l=-m*(s/e)-n.g,h={vCut:4e3,vRef:12e3,altShield:1e4,dynP0:2e5,maxRho:.5},A=_=>_<0?0:_>1?1:_,R=Math.min(c,h.maxRho);let z=(e-h.vCut)/(h.vRef-h.vCut);z=Math.pow(A(z),1.3);const w=Math.max(0,t.z),b=w/(w+h.altShield),v=.5*R*e*e,d=v/(v+h.dynP0),g=z*b*d,E=-(n.Ch*R*x*e*e)/(2*n.Q)*g;return{dxdt:i,dzdt:s,ax:M,az:l,dmdt:E,speed:e}}function j(t,n,i){const s=B(t,i),a={x:t.x+s.dxdt*n/2,z:t.z+s.dzdt*n/2,vx:t.vx+s.ax*n/2,wz:t.wz+s.az*n/2,m:t.m+s.dmdt*n/2},e=B(a,i),x={x:t.x+e.dxdt*n/2,z:t.z+e.dzdt*n/2,vx:t.vx+e.ax*n/2,wz:t.wz+e.az*n/2,m:t.m+e.dmdt*n/2},c=B(x,i),r={x:t.x+c.dxdt*n,z:t.z+c.dzdt*n,vx:t.vx+c.ax*n,wz:t.wz+c.az*n,m:t.m+c.dmdt*n},m=B(r,i),M=t.vx+n*(s.ax+2*e.ax+2*c.ax+m.ax)/6,l=t.wz+n*(s.az+2*e.az+2*c.az+m.az)/6;return{x:t.x+n*(s.dxdt+2*e.dxdt+2*c.dxdt+m.dxdt)/6,z:t.z+n*(s.dzdt+2*e.dzdt+2*c.dzdt+m.dzdt)/6,vx:M,wz:l,m:t.m+n*(s.dmdt+2*e.dmdt+2*c.dmdt+m.dmdt)/6,speed:Math.sqrt(M*M+l*l)}}function et(t,n,i){const s=Math.sqrt(t.vx*t.vx+t.wz*t.wz);let a=i;if(s>25e3?a=Math.min(a,5e-4):s>2e4?a=Math.min(a,.001):s>15e3?a=Math.min(a,.002):s>1e4&&(a=Math.min(a,.005)),t.z>8e4?a=Math.min(a,.01):t.z>5e4?a=Math.min(a,.005):t.z>2e4&&(a=Math.min(a,.002)),Math.abs(t.wz)>0){const e=50/Math.abs(t.wz);a=Math.min(a,e)}return Math.max(1e-6,a)}function O(t,n,i){return t+(n-t)*i}function at(t){const n=t.lat0,i=t.lon0,s=t.bearing,a=t.diameter,e=t.density,x=t.v0,c=t.angleDeg,r=typeof t.alt0=="number"?t.alt0:1e5,m=t.dt&&t.dt>0?t.dt:.02,M=a/2,l=4/3*Math.PI*Math.pow(M,3)*e,h={radius:M,Cd:1,Ch:.005,Q:5e7,g:9.81},A=1e7,R=S(Math.abs(c));let z=x*Math.cos(R),w=-x*Math.sin(R),b=0,v=r,d=l,g=0;const F=[],E=[],_=[],N=[],k=[],V=[],P=[],$=[],ot=2e6,it=5e3,ct=1e4;let T=0,H=!1,G=null,y=!1,K=-1,Y=null;const rt=1e-4;for(;T<ot;){if(v<=0){H=!0;break}const[gt,_t]=U(n,i,s,b);F.push(b),E.push(gt),_.push(_t),N.push(Math.max(0,v));const I=Math.sqrt(z*z+w*w);if(k.push(I),V.push(w),P.push(g),$.push(d),!y&&d<=rt*l){y=!0,K=F.length-1,Y=g,d=0;break}if(T%it===0){const f=(d/l*100).toFixed(2);console.log(`[worker] step ${T} t=${g.toFixed(1)}s alt=${(v/1e3).toFixed(2)}km speed=${(I/1e3).toFixed(2)}km/s mass=${f}%`)}const u={x:b,z:v,vx:z,wz:w,m:d};let p=et(u,h,m);v<ct&&(p=Math.min(p,.001));let o=j(u,p,h),nt=0;const bt=6,Ft=Math.max(I,1e-6);for(;nt<bt;){let f=!1;o.z>u.z+Math.max(100,Math.abs(u.z)*.01)&&(f=!0);const C=Math.sqrt(o.vx*o.vx+o.wz*o.wz)/Ft;if((C>1.5||C<.5)&&(f=!0),Math.sqrt(Math.pow((o.vx-u.vx)/p,2)+Math.pow((o.wz-u.wz)/p,2))>5e3&&(f=!0),(!isFinite(o.x)||!isFinite(o.z)||!isFinite(o.vx)||!isFinite(o.wz)||!isFinite(o.m))&&(f=!0),!f)break;if(p*=.3,p<1e-6){console.warn("[worker] dt underflow terminating");break}o=j(u,p,h),nt++}if(o.z<=0){const f=u.z/(u.z-o.z),J=O(u.x,o.x,f),C=O(u.vx,o.vx,f),D=O(u.wz,o.wz,f),kt=Math.sqrt(C*C+D*D),[yt,At]=U(n,i,s,J),Q=g+p*f;F.push(J),E.push(yt),_.push(At),N.push(0),k.push(kt),V.push(D),P.push(Q),$.push(d),g=Q,H=!0,G=Q;break}b=o.x,v=o.z,z=o.vx,w=o.wz,d=Math.max(0,o.m),g+=p,T++,.5*W(Math.max(0,v))*(z*z+w*w)>A&&Math.random()<.02&&(d*=.95)}const lt=F.length,mt=new Float64Array(F).buffer,ht=new Float64Array(E).buffer,dt=new Float64Array(_).buffer,ut=new Float32Array(N).buffer,ft=new Float32Array(k).buffer,xt=new Float32Array(V).buffer,Mt=new Float64Array(P).buffer,zt=new Float64Array($).buffer,q=.5*l*x*x,Z=k.length?k[k.length-1]:0,L=.5*d*Z*Z,tt=L>0?L:q,st=1435e-8*Math.pow(tt,1/3.4),wt=st*1e3*5,vt=tt*57e-6,pt=(Math.log10(vt)-5.24)/1.44;return{xs:mt,lats:ht,lons:dt,alts:ut,vs:ft,wzs:xt,times:Mt,ms:zt,crater_km:y?0:st,mw:y?0:pt,tsunami_m:y?0:wt,meta:{impacted:H,disintegrated:y,disintegrationIndex:K,disintegrationTime:Y,steps:T,impactTime:G,lastAlt:N[lt-1],lastTime:P[P.length-1],initialEkJ:q,residualEkJ:L,energyFraction:q>0?L/q:1,initialMass:l,finalMass:d}}}})();
