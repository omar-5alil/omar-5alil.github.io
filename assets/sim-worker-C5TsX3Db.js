(function(){"use strict";self.addEventListener("message",t=>{const n=t.data;if(!n||n.cmd!=="run")return;const i=n.params,s=it(i);self.postMessage({type:"simResult",xs:s.xs,lats:s.lats,lons:s.lons,alts:s.alts,vs:s.vs,wzs:s.wzs,times:s.times,ms:s.ms,crater_km:s.crater_km,mw:s.mw,tsunami_m:s.tsunami_m,meta:s.meta},[s.xs,s.lats,s.lons,s.alts,s.vs,s.wzs,s.times,s.ms])});function S(t){return t*Math.PI/180}function W(t){return t*180/Math.PI}function j(t,n,i,s){const e=S(t),x=S(n),c=S(i),r=s/6371e3,m=Math.sin(e)*Math.cos(r)+Math.cos(e)*Math.sin(r)*Math.cos(c),M=Math.asin(Math.max(-1,Math.min(1,m))),l=Math.sin(c)*Math.sin(r)*Math.cos(e),h=Math.cos(r)-Math.sin(e)*Math.sin(M),A=x+Math.atan2(l,h);return[W(M),(W(A)+540)%360-180]}function G(t){if(t>1e6)return 1e-15;if(t>86e3){const n=1.225*Math.exp(-10.117647058823529)*.001;return Math.max(1e-12,n*Math.exp(-(t-86e3)/1e5))}else return t>5e4?1.225*Math.exp(-5.882352941176471)*Math.exp(-(t-5e4)/7e3):1.225*Math.exp(-t/8500)}function B(t,n){const i=t.vx,s=t.wz,a=t.m,e=Math.sqrt(i*i+s*s)||1e-6,x=Math.PI*(n.radius*n.radius),c=G(Math.max(0,t.z));let r=n.Cd;e>15e3?r=.3:e>8e3?r=.5:r=1;const m=.5*r*c*x*e*e/Math.max(1e-9,a),M=-m*(i/e),l=-m*(s/e)-n.g,h={vCut:4e3,vRef:12e3,altShield:1e4,dynP0:2e5,maxRho:.5},A=b=>b<0?0:b>1?1:b,R=Math.min(c,h.maxRho);let p=(e-h.vCut)/(h.vRef-h.vCut);p=Math.pow(A(p),1.3);const z=Math.max(0,t.z),_=z/(z+h.altShield),w=.5*R*e*e,d=w/(w+h.dynP0),g=p*_*d,E=-(n.Ch*R*x*e*e)/(2*n.Q)*g;return{dxdt:i,dzdt:s,ax:M,az:l,dmdt:E,speed:e}}function I(t,n,i){const s=B(t,i),a={x:t.x+s.dxdt*n/2,z:t.z+s.dzdt*n/2,vx:t.vx+s.ax*n/2,wz:t.wz+s.az*n/2,m:t.m+s.dmdt*n/2},e=B(a,i),x={x:t.x+e.dxdt*n/2,z:t.z+e.dzdt*n/2,vx:t.vx+e.ax*n/2,wz:t.wz+e.az*n/2,m:t.m+e.dmdt*n/2},c=B(x,i),r={x:t.x+c.dxdt*n,z:t.z+c.dzdt*n,vx:t.vx+c.ax*n,wz:t.wz+c.az*n,m:t.m+c.dmdt*n},m=B(r,i),M=t.vx+n*(s.ax+2*e.ax+2*c.ax+m.ax)/6,l=t.wz+n*(s.az+2*e.az+2*c.az+m.az)/6;return{x:t.x+n*(s.dxdt+2*e.dxdt+2*c.dxdt+m.dxdt)/6,z:t.z+n*(s.dzdt+2*e.dzdt+2*c.dzdt+m.dzdt)/6,vx:M,wz:l,m:t.m+n*(s.dmdt+2*e.dmdt+2*c.dmdt+m.dmdt)/6,speed:Math.sqrt(M*M+l*l)}}function ot(t,n,i){const s=Math.sqrt(t.vx*t.vx+t.wz*t.wz);let a=i;if(s>25e3?a=Math.min(a,5e-4):s>2e4?a=Math.min(a,.001):s>15e3?a=Math.min(a,.002):s>1e4&&(a=Math.min(a,.005)),t.z>8e4?a=Math.min(a,.01):t.z>5e4?a=Math.min(a,.005):t.z>2e4&&(a=Math.min(a,.002)),Math.abs(t.wz)>0){const e=50/Math.abs(t.wz);a=Math.min(a,e)}return Math.max(1e-6,a)}function D(t,n,i){return t+(n-t)*i}function it(t){const n=t.lat0,i=t.lon0,s=t.bearing,a=t.diameter,e=t.density,x=t.v0,c=t.angleDeg,r=typeof t.alt0=="number"?t.alt0:1e5,m=t.dt&&t.dt>0?t.dt:.02,M=a/2,l=4/3*Math.PI*Math.pow(M,3)*e,h={radius:M,Cd:1,Ch:.005,Q:5e7,g:9.81},A=1e7,R=S(Math.abs(c));let p=x*Math.cos(R),z=-x*Math.sin(R),_=0,w=r,d=l,g=0;const k=[],E=[],b=[],N=[],F=[],H=[],P=[],J=[],ct=5e3,rt=1e4;let q=0,Q=!1,K=null,y=!1,Y=-1,Z=null;const lt=1e-4;let T=!1,tt=null;for(;;){if(w<=0){Q=!0;break}const[bt,_t]=j(n,i,s,_);k.push(_),E.push(bt),b.push(_t),N.push(Math.max(0,w));const V=Math.sqrt(p*p+z*z);if(F.push(V),H.push(z),P.push(g),J.push(d),!y&&d<=lt*l){y=!0,Y=k.length-1,Z=g,d=0;break}if(w>1e6&&z>0&&V<1e3){T=!0,tt="ballistic_escape";break}if(q%ct===0){const f=(d/l*100).toFixed(2);console.log(`[worker] step ${q} t=${g.toFixed(1)}s alt=${(w/1e3).toFixed(2)}km speed=${(V/1e3).toFixed(2)}km/s mass=${f}%`)}const u={x:_,z:w,vx:p,wz:z,m:d};let v=ot(u,h,m);w<rt&&(v=Math.min(v,.001));let o=I(u,v,h),at=0;const kt=6,Ft=Math.max(V,1e-6);for(;at<kt;){let f=!1;o.z>u.z+Math.max(100,Math.abs(u.z)*.01)&&(f=!0);const C=Math.sqrt(o.vx*o.vx+o.wz*o.wz)/Ft;if((C>1.5||C<.5)&&(f=!0),Math.sqrt(Math.pow((o.vx-u.vx)/v,2)+Math.pow((o.wz-u.wz)/v,2))>5e3&&(f=!0),(!isFinite(o.x)||!isFinite(o.z)||!isFinite(o.vx)||!isFinite(o.wz)||!isFinite(o.m))&&(f=!0),!f)break;if(v*=.3,v<1e-6){console.warn("[worker] dt underflow terminating");break}o=I(u,v,h),at++}if(o.z<=0){const f=u.z/(u.z-o.z),X=D(u.x,o.x,f),C=D(u.vx,o.vx,f),$=D(u.wz,o.wz,f),yt=Math.sqrt(C*C+$*$),[At,Rt]=j(n,i,s,X),U=g+v*f;k.push(X),E.push(At),b.push(Rt),N.push(0),F.push(yt),H.push($),P.push(U),J.push(d),g=U,Q=!0,K=U;break}_=o.x,w=o.z,p=o.vx,z=o.wz,d=Math.max(0,o.m),g+=v,q++,.5*G(Math.max(0,w))*(p*p+z*z)>A&&Math.random()<.02&&(d*=.95)}const mt=k.length,ht=new Float64Array(k).buffer,dt=new Float64Array(E).buffer,ut=new Float64Array(b).buffer,ft=new Float32Array(N).buffer,xt=new Float32Array(F).buffer,Mt=new Float32Array(H).buffer,zt=new Float64Array(P).buffer,wt=new Float64Array(J).buffer,L=.5*l*x*x,st=F.length?F[F.length-1]:0,O=.5*d*st*st,nt=O>0?O:L,et=1435e-8*Math.pow(nt,1/3.4),pt=et*1e3*5,vt=nt*57e-6,gt=(Math.log10(vt)-5.24)/1.44;return{xs:ht,lats:dt,lons:ut,alts:ft,vs:xt,wzs:Mt,times:zt,ms:wt,crater_km:y||T?0:et,mw:y||T?0:gt,tsunami_m:y||T?0:pt,meta:{impacted:Q,disintegrated:y,disintegrationIndex:Y,disintegrationTime:Z,earlyTermination:T,terminationReason:tt,steps:q,impactTime:K,lastAlt:N[mt-1],lastTime:P[P.length-1],initialEkJ:L,residualEkJ:O,energyFraction:L>0?O/L:1,initialMass:l,finalMass:d}}}})();
