(function(){"use strict";self.addEventListener("message",t=>{const n=t.data;if(!n||n.cmd!=="run")return;const i=n.params,s=it(i);self.postMessage({type:"simResult",xs:s.xs,lats:s.lats,lons:s.lons,alts:s.alts,vs:s.vs,wzs:s.wzs,times:s.times,ms:s.ms,crater_km:s.crater_km,mw:s.mw,tsunami_m:s.tsunami_m,meta:s.meta},[s.xs,s.lats,s.lons,s.alts,s.vs,s.wzs,s.times,s.ms])});function C(t){return t*Math.PI/180}function W(t){return t*180/Math.PI}function j(t,n,i,s){const e=C(t),m=C(n),c=C(i),r=s/6371e3,d=Math.sin(e)*Math.cos(r)+Math.cos(e)*Math.sin(r)*Math.cos(c),h=Math.asin(Math.max(-1,Math.min(1,d))),l=Math.sin(c)*Math.sin(r)*Math.cos(e),f=Math.cos(r)-Math.sin(e)*Math.sin(h),M=m+Math.atan2(l,f);return[W(h),(W(M)+540)%360-180]}function G(t){const s=[{z0:0,T0:288.15,P0:101325,L:-.0065},{z0:11e3,T0:216.65,P0:22632.1,L:0},{z0:2e4,T0:216.65,P0:5474.89,L:.001},{z0:32e3,T0:228.65,P0:868.019,L:.0028},{z0:47e3,T0:270.65,P0:110.906,L:0},{z0:51e3,T0:270.65,P0:66.9389,L:-.0028},{z0:71e3,T0:214.65,P0:3.9564,L:-.002}];if(t>86e3)return 1.225*Math.exp(-10.117647058823529)*Math.exp(-(t-86e3)/1e4);let a;for(let M=s.length-1;M>=0;M--)if(t>=s[M].z0){a=s[M];break}const{z0:e,T0:m,P0:c,L:r}=a,d=t-e;let h,l;return r===0?(h=m,l=c*Math.exp(-9.80665*d/(287.05*m))):(h=m+r*d,l=c*Math.pow(m/h,9.80665/(287.05*r))),l/(287.05*h)}function S(t,n){const i=t.vx,s=t.wz,a=t.m,e=Math.sqrt(i*i+s*s)||1e-6,m=Math.PI*(n.radius*n.radius),c=G(Math.max(0,t.z));let r=n.Cd;e>15e3?r=.3:e>8e3?r=.5:r=1;const d=.5*r*c*m*e*e/Math.max(1e-9,a),h=-d*(i/e),l=-d*(s/e)-n.g,f={vCut:4e3,vRef:12e3,altShield:1e4,dynP0:2e5,maxRho:.5},M=_=>_<0?0:_>1?1:_,T=Math.min(c,f.maxRho);let v=(e-f.vCut)/(f.vRef-f.vCut);v=Math.pow(M(v),1.3);const w=Math.max(0,t.z),k=w/(w+f.altShield),p=.5*T*e*e,u=p/(p+f.dynP0),b=v*k*u,R=-(n.Ch*T*m*e*e)/(2*n.Q)*b;return{dxdt:i,dzdt:s,ax:h,az:l,dmdt:R,speed:e}}function I(t,n,i){const s=S(t,i),a={x:t.x+s.dxdt*n/2,z:t.z+s.dzdt*n/2,vx:t.vx+s.ax*n/2,wz:t.wz+s.az*n/2,m:t.m+s.dmdt*n/2},e=S(a,i),m={x:t.x+e.dxdt*n/2,z:t.z+e.dzdt*n/2,vx:t.vx+e.ax*n/2,wz:t.wz+e.az*n/2,m:t.m+e.dmdt*n/2},c=S(m,i),r={x:t.x+c.dxdt*n,z:t.z+c.dzdt*n,vx:t.vx+c.ax*n,wz:t.wz+c.az*n,m:t.m+c.dmdt*n},d=S(r,i),h=t.vx+n*(s.ax+2*e.ax+2*c.ax+d.ax)/6,l=t.wz+n*(s.az+2*e.az+2*c.az+d.az)/6;return{x:t.x+n*(s.dxdt+2*e.dxdt+2*c.dxdt+d.dxdt)/6,z:t.z+n*(s.dzdt+2*e.dzdt+2*c.dzdt+d.dzdt)/6,vx:h,wz:l,m:t.m+n*(s.dmdt+2*e.dmdt+2*c.dmdt+d.dmdt)/6,speed:Math.sqrt(h*h+l*l)}}function ot(t,n,i){const s=Math.sqrt(t.vx*t.vx+t.wz*t.wz);let a=i;if(s>25e3?a=Math.min(a,5e-4):s>2e4?a=Math.min(a,.001):s>15e3?a=Math.min(a,.002):s>1e4&&(a=Math.min(a,.005)),t.z>8e4?a=Math.min(a,.01):t.z>5e4?a=Math.min(a,.005):t.z>2e4&&(a=Math.min(a,.002)),Math.abs(t.wz)>0){const e=50/Math.abs(t.wz);a=Math.min(a,e)}return Math.max(1e-6,a)}function D(t,n,i){return t+(n-t)*i}function it(t){const n=t.lat0,i=t.lon0,s=t.bearing,a=t.diameter,e=t.density,m=t.v0,c=t.angleDeg,r=typeof t.alt0=="number"?t.alt0:1e5,d=t.dt&&t.dt>0?t.dt:.02,h=a/2,l=4/3*Math.PI*Math.pow(h,3)*e,f={radius:h,Cd:1,Ch:.005,Q:5e7,g:9.81},M=1e7,T=C(Math.abs(c));let v=m*Math.cos(T),w=-m*Math.sin(T),k=0,p=r,u=l,b=0;const y=[],R=[],_=[],B=[],F=[],J=[],A=[],Q=[],ct=5e3,rt=1e4;let N=0,X=!1,K=null,P=!1,Y=-1,Z=null;const lt=1e-4;let E=!1,tt=null;for(;;){if(p<=0){X=!0;break}const[bt,_t]=j(n,i,s,k);y.push(k),R.push(bt),_.push(_t),B.push(Math.max(0,p));const V=Math.sqrt(v*v+w*w);if(F.push(V),J.push(w),A.push(b),Q.push(u),!P&&u<=lt*l){P=!0,Y=y.length-1,Z=b,u=0;break}if(p>1e6&&w>0&&V<1e3){E=!0,tt="ballistic_escape";break}if(N%ct===0){const z=(u/l*100).toFixed(2);console.log(`[worker] step ${N} t=${b.toFixed(1)}s alt=${(p/1e3).toFixed(2)}km speed=${(V/1e3).toFixed(2)}km/s mass=${z}%`)}const x={x:k,z:p,vx:v,wz:w,m:u};let g=ot(x,f,d);p<rt&&(g=Math.min(g,.001));let o=I(x,g,f),at=0;const kt=6,yt=Math.max(V,1e-6);for(;at<kt;){let z=!1;o.z>x.z+Math.max(100,Math.abs(x.z)*.01)&&(z=!0);const L=Math.sqrt(o.vx*o.vx+o.wz*o.wz)/yt;if((L>1.5||L<.5)&&(z=!0),Math.sqrt(Math.pow((o.vx-x.vx)/g,2)+Math.pow((o.wz-x.wz)/g,2))>5e3&&(z=!0),(!isFinite(o.x)||!isFinite(o.z)||!isFinite(o.vx)||!isFinite(o.wz)||!isFinite(o.m))&&(z=!0),!z)break;if(g*=.3,g<1e-6){console.warn("[worker] dt underflow terminating");break}o=I(x,g,f),at++}if(o.z<=0){const z=x.z/(x.z-o.z),H=D(x.x,o.x,z),L=D(x.vx,o.vx,z),$=D(x.wz,o.wz,z),Ft=Math.sqrt(L*L+$*$),[Pt,Tt]=j(n,i,s,H),U=b+g*z;y.push(H),R.push(Pt),_.push(Tt),B.push(0),F.push(Ft),J.push($),A.push(U),Q.push(u),b=U,X=!0,K=U;break}k=o.x,p=o.z,v=o.vx,w=o.wz,u=Math.max(0,o.m),b+=g,N++,.5*G(Math.max(0,p))*(v*v+w*w)>M&&Math.random()<.02&&(u*=.95)}const mt=y.length,ht=new Float64Array(y).buffer,dt=new Float64Array(R).buffer,ft=new Float64Array(_).buffer,ut=new Float32Array(B).buffer,xt=new Float32Array(F).buffer,zt=new Float32Array(J).buffer,Mt=new Float64Array(A).buffer,wt=new Float64Array(Q).buffer,q=.5*l*m*m,st=F.length?F[F.length-1]:0,O=.5*u*st*st,nt=O>0?O:q,et=1435e-8*Math.pow(nt,1/3.4),pt=et*1e3*5,vt=nt*57e-6,gt=(Math.log10(vt)-5.24)/1.44;return{xs:ht,lats:dt,lons:ft,alts:ut,vs:xt,wzs:zt,times:Mt,ms:wt,crater_km:P||E?0:et,mw:P||E?0:gt,tsunami_m:P||E?0:pt,meta:{impacted:X,disintegrated:P,disintegrationIndex:Y,disintegrationTime:Z,earlyTermination:E,terminationReason:tt,steps:N,impactTime:K,lastAlt:B[mt-1],lastTime:A[A.length-1],initialEkJ:q,residualEkJ:O,energyFraction:q>0?O/q:1,initialMass:l,finalMass:u}}}})();
